{% extends 'base.html' %}
{% block title %}Result - Order Availability Checker{% endblock %}

{% block head_extra %}
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
      /* Dark theme fixes for result page */
      [data-bs-theme="dark"] .text-dark {
        color: var(--text-primary) !important;
      }
      
      [data-bs-theme="dark"] .text-muted {
        color: var(--text-secondary) !important;
      }
      
      [data-bs-theme="dark"] .table {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .table th,
      [data-bs-theme="dark"] .table td {
        background-color: var(--card-bg);
        color: var(--text-primary);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > td {
        background-color: rgba(255, 255, 255, 0.05);
      }
      
      [data-bs-theme="dark"] .alert {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .form-control,
      [data-bs-theme="dark"] .form-select {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .form-control:focus,
      [data-bs-theme="dark"] .form-select:focus {
        background-color: var(--bg-secondary);
        border-color: #2563eb;
        color: var(--text-primary);
        box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary:hover {
        color: var(--text-primary);
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .dropdown-menu {
        background-color: var(--card-bg);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .dropdown-item {
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .dropdown-item:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
      }
      
      /* Maintain status colors in dark theme */
      .status-full {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
      }
      
      .status-not-full {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
      }
      
      .status-not-have {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
      }
      
      [data-bs-theme="dark"] .status-full {
        background-color: rgba(40, 167, 69, 0.3);
        color: #5cbf5c;
      }
      
      [data-bs-theme="dark"] .status-not-full {
        background-color: rgba(255, 193, 7, 0.3);
        color: #ffd43b;
      }
      
      [data-bs-theme="dark"] .status-not-have {
        background-color: rgba(220, 53, 69, 0.3);
        color: #e74c3c;
      }
      
      /* Fix table text visibility in dark mode */
      [data-bs-theme="dark"] .table tbody tr td {
        color: var(--text-primary) !important;
        background-color: var(--card-bg) !important;
      }
      
      [data-bs-theme="dark"] .table thead tr th {
        color: var(--text-primary) !important;
        background-color: var(--bg-secondary) !important;
      }
      
      [data-bs-theme="dark"] .break-anywhere {
        color: var(--text-primary) !important;
      }
      
      [data-bs-theme="dark"] .text-end {
        color: var(--text-primary) !important;
      }
    </style>
{% endblock %}

{% block content %}
    <div class="container py-5">
      <!-- Header Section -->
      <div class="row align-items-center mb-4">
        <div class="col-md-8">
          {% if is_historical %}
          <h1 class="display-6 fw-bold text-gradient mb-2">
            <i class="bi bi-clock-history me-2"></i>Saved Processing Results
          </h1>
          {% else %}
          <h1 class="display-6 fw-bold text-gradient mb-2">Processing Results</h1>
          {% endif %}
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="d-flex align-items-center">
              <i class="bi bi-database text-primary me-2"></i>
              <span class="text-muted">Stock: <strong class="text-dark">{{ stock_name }}</strong></span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-cart text-success me-2"></i>
              <span class="text-muted">Order: <strong class="text-dark">{{ order_name }}</strong></span>
            </div>
            {% if is_historical %}
            <div class="d-flex align-items-center">
              <span class="badge bg-info text-white">
                <i class="bi bi-archive me-1"></i>Historical Data
              </span>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
            <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
              <i class="bi bi-arrow-left me-2"></i>{% if is_historical %}Back to Home{% else %}Process Another{% endif %}
            </a>
            {% if download_token %}
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-download me-2"></i>Download
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('download_excel', token=download_token) }}">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>Excel File
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('download_pdf', token=download_token) }}">
                  <i class="bi bi-file-earmark-pdf me-2"></i>PDF Report
                </a></li>
              </ul>
            </div>
            {% else %}
            <div class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>Downloads not available for historical data
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row g-4 mb-5">
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-primary text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Total Items</div>
              <i class="bi bi-box display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.total_items }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Total: {{ summary.total_kg_all }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-success text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Available</div>
              <i class="bi bi-check-circle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.full }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Ready: {{ summary.total_kg_full }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-warning text-dark">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Not Full</div>
              <i class="bi bi-exclamation-triangle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.not_full }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Limited: {{ summary.total_kg_not_full }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-secondary text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Not have</div>
              <i class="bi bi-x-circle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.not_have }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Missing: {{ summary.total_kg_not_have }} KG
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <ul class="nav nav-pills" id="statusTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center" id="tab-all" data-bs-toggle="pill" data-bs-target="#pane-all" type="button" role="tab">
              <i class="bi bi-list-ul me-2"></i>All Items
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-full" data-bs-toggle="pill" data-bs-target="#pane-full" type="button" role="tab">
              <i class="bi bi-check-circle me-2"></i>Available
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-notfull" data-bs-toggle="pill" data-bs-target="#pane-notfull" type="button" role="tab">
              <i class="bi bi-exclamation-triangle me-2"></i>Not Full
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-nothave" data-bs-toggle="pill" data-bs-target="#pane-nothave" type="button" role="tab">
              <i class="bi bi-x-circle me-2"></i>Not have
            </button>
          </li>
        </ul>
        
        <!-- Search and Filter Controls -->
        <div class="d-flex gap-2">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="Search items..." id="table-search">
          </div>
        </div>
      </div>

      <!-- Advanced toggle -->
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-dark btn-sm" id="toggleAdvanced">Advance Table</button>
      </div>

      <!-- Simple table (default) -->
      <div id="simpleTable">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-compact align-middle m-0">
                <thead class="table-light">
                  <tr>
                    <th>Fish Name</th>
                    <th>Packed Size</th>
                    <th class="text-end">Order CTN</th>
                    <th class="text-end">Order KG/CTN</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in records %}
                  <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                    <td>{{ r['fish name'] }}</td>
                    <td>{{ r['packed size'] }}</td>
                    <td class="text-end">{{ r.order_carton }}</td>
                    <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                    <td>
                      {% if r.status == 'Full' %}
                        <span class="badge bg-success">Full</span>
                      {% elif r.status == 'Not Full' %}
                        <span class="badge bg-warning text-dark">Not Full</span>
                      {% else %}
                        <span class="badge bg-secondary">Not have</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced table (hidden by default) -->
      <div id="advancedTable" class="d-none">
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-all" role="tabpanel">
          <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-compact align-middle m-0">
              <thead class="table-light">
                <tr>
                  <th>Fish Name</th>
                  <th>Packed Size</th>
                  <th class="text-end">Order CTN</th>
                  <th class="text-end">Stock CTN</th>
                  <th class="text-end">Order KG/CTN</th>
                  <th class="text-end">Stock KG/CTN</th>
                  <th class="text-end">Balance Stock CTN</th>
                   <th class="text-end">MC To Give</th>
                   <th class="text-end">Can Fulfill</th>
                  <th class="text-end">Shortfall</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for r in records %}
                <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                  <td>{{ r['fish name'] }}</td>
                  <td>{{ r['packed size'] }}</td>
                  <td class="text-end">{{ r.order_carton }}</td>
                  <td class="text-end">{{ r.stock_carton }}</td>
                  <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                  <td class="text-end">{{ r.stock_kg_per_ctn }}</td>
                  <td class="text-end">{{ r.balance_stock_carton }}</td>
                  <td class="text-end">{{ r.mc_to_give }}</td>
                  <td class="text-end">{{ r.can_fulfill_carton }}</td>
                  <td class="text-end">{{ r.shortfall }}</td>
                  <td>
                    {% if r.status == 'Full' %}
                      <span class="badge bg-success">Full</span>
                    {% elif r.status == 'Not Full' %}
                      <span class="badge bg-warning text-dark">Not Full</span>
                    {% else %}
                      <span class="badge bg-secondary">Not have</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        {% for label in ['Full','Not Full','Not have'] %}
        <div class="tab-pane fade" id="pane-{{ label|lower|replace(' ', '') }}" role="tabpanel">
          <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-compact align-middle m-0">
                  <thead class="table-light">
                    <tr>
                      <th>Fish Name</th>
                      <th>Packed Size</th>
                      <th class="text-end" data-full-text="Order CTN" data-mobile-text="O.CTN">Order CTN</th>
                      <th class="text-end" data-full-text="Stock CTN" data-mobile-text="S.CTN">Stock CTN</th>
                      <th class="text-end" data-full-text="Order KG/CTN" data-mobile-text="O.KG">Order KG/CTN</th>
                      <th class="text-end" data-full-text="Stock KG/CTN" data-mobile-text="S.KG">Stock KG/CTN</th>
                      <th class="text-end" data-full-text="Balance Stock CTN" data-mobile-text="BAL">Balance Stock CTN</th>
                      <th class="text-end" data-full-text="MC To Give" data-mobile-text="MC">MC To Give</th>
                      <th class="text-end" data-full-text="Can Fulfill" data-mobile-text="CAN">Can Fulfill</th>
                      <th class="text-end" data-full-text="Shortfall" data-mobile-text="SHORT">Shortfall</th>
                      <th data-full-text="Status" data-mobile-text="ST">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in records if r.status == label %}
                    <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                      <td>{{ r['fish name'] }}</td>
                      <td>{{ r['packed size'] }}</td>
                      <td class="text-end">{{ r.order_carton }}</td>
                      <td class="text-end">{{ r.stock_carton }}</td>
                      <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                      <td class="text-end">{{ r.stock_kg_per_ctn }}</td>
                      <td class="text-end">{{ r.balance_stock_carton }}</td>
                      <td class="text-end">{{ r.mc_to_give }}</td>
                      <td class="text-end">{{ r.can_fulfill_carton }}</td>
                      <td class="text-end">{{ r.shortfall }}</td>
                      <td>
                        {% if r.status == 'Full' %}
                          <span class="badge bg-success">Full</span>
                        {% elif r.status == 'Not Full' %}
                          <span class="badge bg-warning text-dark">Not Full</span>
                        {% else %}
                          <span class="badge bg-secondary">Not have</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>

    </div>
{% endblock %}

{% block scripts %}
    <script>
      // Enhanced table search functionality
      (() => {
        const simple = document.getElementById('simpleTable');
        const advanced = document.getElementById('advancedTable');
        const toggleBtn = document.getElementById('toggleAdvanced');

        // Helper: filter simple table by active status tab
        function applyStatusFilterToSimple(activeKey) {
          if (!simple) return;
          const rows = simple.querySelectorAll('tbody tr');
          rows.forEach(row => {
            row.style.display = '';
          });
          if (activeKey === 'all') return;
          const classMap = {
            full: 'status-full',
            notfull: 'status-not-full',
            nothave: 'status-not-have',
          };
          const want = classMap[activeKey];
          rows.forEach(row => {
            const has = row.classList.contains(want);
            row.style.display = has ? '' : 'none';
          });
        }

        // Determine current active tab key
        function getActiveKey() {
          const activeBtn = document.querySelector('#statusTabs .nav-link.active');
          if (!activeBtn) return 'all';
          if (activeBtn.id === 'tab-full') return 'full';
          if (activeBtn.id === 'tab-notfull') return 'notfull';
          if (activeBtn.id === 'tab-nothave') return 'nothave';
          return 'all';
        }
        if (toggleBtn && simple && advanced) {
          function setAdvancedButton(active) {
            if (active) {
              toggleBtn.classList.add('active');
              toggleBtn.classList.remove('btn-outline-dark');
              toggleBtn.classList.add('btn-primary');
              toggleBtn.innerHTML = '<i class="bi bi-toggle-on me-2"></i>Advance Table';
              toggleBtn.setAttribute('aria-pressed', 'true');
            } else {
              toggleBtn.classList.remove('active');
              toggleBtn.classList.add('btn-outline-dark');
              toggleBtn.classList.remove('btn-primary');
              toggleBtn.innerHTML = '<i class="bi bi-toggle-off me-2"></i>Advance Table';
              toggleBtn.setAttribute('aria-pressed', 'false');
            }
          }
          // Always start with simple table visible
          simple.classList.remove('d-none');
          advanced.classList.add('d-none');
          toggleBtn.addEventListener('click', () => {
            const advancedVisible = !advanced.classList.contains('d-none');
            if (advancedVisible) {
              // show simple
              advanced.classList.add('d-none');
              simple.classList.remove('d-none');
              applyStatusFilterToSimple(getActiveKey());
              setAdvancedButton(false);
            } else {
              // show advanced
              simple.classList.add('d-none');
              advanced.classList.remove('d-none');
              setAdvancedButton(true);
            }
          });
          // Initial filter for simple
          applyStatusFilterToSimple(getActiveKey());
          setAdvancedButton(false);
        }

        const searchInput = document.getElementById('table-search');
        
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const container = simple && !simple.classList.contains('d-none') ? simple : advanced;
            const bodies = container.querySelectorAll('.table tbody');
            bodies.forEach(tbody => {
              const rows = tbody.querySelectorAll('tr');
              rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                  row.style.display = '';
                } else {
                  row.style.display = 'none';
                }
              });
            });
          });
        }
        
        // Add smooth animations to cards
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('animate-in');
            }
          });
        });
        
        document.querySelectorAll('.stat-card, .card').forEach(el => {
          observer.observe(el);
        });
        
        // React to status tab changes to filter simple table
        document.getElementById('statusTabs')?.addEventListener('shown.bs.tab', (ev) => {
          if (!simple || simple.classList.contains('d-none')) return;
          applyStatusFilterToSimple(getActiveKey());
        });

        // Removed table row hover effects for better mobile experience
      })();
    </script>
{% endblock %}


